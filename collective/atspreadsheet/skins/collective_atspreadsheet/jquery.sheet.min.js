/*
jQuery.sheet() Spreadsheet with Calculations Plugin
Version: 1 Release Candidate 1
http://code.google.com/p/jquerysheet/
		
Copyright (C) 2010 Robert Plummer
Dual licensed under the LGPL and GPL licenses.
http://www.gnu.org/licenses/
*/
jQuery.fn.extend({sheet:function(c){c=jQuery.extend({urlGet:"documentation.html",urlSave:"save.html",editable:true,urlMenu:"menu.html",newColumnWidth:120,title:null,inlineMenu:null,buildSheet:false,calcOff:false,log:false,lockFormulas:false,parent:this,colMargin:18,fnBefore:function(){},fnAfter:function(){},fnSave:function(){jS.saveSheet()},fnOpen:function(){var e=prompt("Paste your table html here");if(e){jS.openSheet(e)}},fnClose:function(){},joinedResizing:false,boxModelCorrection:2},c);jQuery.fn.sheet.settings=jS.s=c;jS.s.fnBefore();var d;if(jS.s.buildSheet){if(typeof(jS.s.buildSheet)=="object"){d=jS.s.buildSheet}else{if(jS.s.buildSheet==true||jS.s.buildSheet=="true"){d=jQuery(jQuery(this).html())}else{if(jS.s.buildSheet.match(/x/i)){d=jS.controlFactory.sheet(jS.s.buildSheet)}}}}jQuery(this).html("");jS.s.width=jQuery(this).width();jS.s.height=jQuery(this).height();if(jS.s.log){jQuery(jS.s.parent).after('<textarea id="'+jS.id.log+'" />')}else{jS.log=function(){}}if(!jQuery.scrollTo){jS.followMe=function(){}}jS.log("Startup");for(var a in cE.fn){var b=a.toLowerCase();if(b!=a){cE.fn[b]=cE.fn[a]}}jQuery(window).resize(function(){jS.s.width=jQuery(jS.s.parent).width();jS.s.height=jQuery(jS.s.parent).height();jS.sheetSyncSize()});jS.openSheet(d)}});var jS=jQuery.sheet={version:"1rc1",i:0,sheetCount:0,s:{},obj:{parent:function(){return jQuery(jS.s.parent)},ui:function(){return jQuery("#"+jS.id.ui)},sheet:function(){return jQuery("#"+jS.id.sheet+jS.i)},sheetAll:function(){return jQuery("."+jS.cl.sheet)},barTop:function(){return jQuery("#"+jS.id.barTop+jS.i)},barTopParent:function(){return jQuery("#"+jS.id.barTopParent+jS.i)},barLeft:function(){return jQuery("#"+jS.id.barLeft+jS.i)},barLeftParent:function(){return jQuery("#"+jS.id.barLeftParent+jS.i)},barCorner:function(){return jQuery("#"+jS.id.barCorner+jS.i)},barCornerParent:function(){return jQuery("#"+jS.id.barCornerParent+jS.i)},barSelected:function(){return jQuery("."+jS.cl.barSelected)},cell:function(){return jQuery("."+jS.cl.cell)},controls:function(){return jQuery("#"+jS.id.controls)},formula:function(){return jQuery("#"+jS.id.formula)},label:function(){return jQuery("#"+jS.id.label)},fx:function(){return jQuery("#"+jS.id.fx)},pane:function(){return jQuery("#"+jS.id.pane+jS.i)},log:function(){return jQuery("#"+jS.id.log)},menu:function(){return jQuery("#"+jS.id.menu)},uiDefault:function(){return jQuery("."+jS.cl.uiDefault)},uiActive:function(){return jQuery("."+jS.cl.uiActive)},uiBase:function(){return jQuery("."+jS.cl.uiBase)},uiCell:function(){return jQuery("."+jS.cl.uiCell)},toggle:function(){return jQuery("."+jS.cl.toggle)},tableBody:function(){return document.getElementById(jS.id.sheet+jS.i)},tableControl:function(){return jQuery("#"+jS.id.tableControl+jS.i)},tab:function(){return jQuery("#"+jS.id.tab+jS.i)},tabContainer:function(){return jQuery("#"+jS.id.tabContainer)}},id:{sheet:"jSheet",ui:"jSheetUI",barTop:"jSheetBarTop",barTopParent:"jSheetBarTopParent",barLeft:"jSheetBarLeft",barLeftParent:"jSheetBarLeftParent",barCorner:"jSheetBarCorner",barCornerParent:"jSheetBarCornerParent",controls:"jSheetControls",formula:"jSheetControls_formula",label:"jSheetControls_loc",fx:"jSheetControls_fx",pane:"jSheetEditPane",log:"jSheetLog",menu:"jSheetMenu",tableControl:"tableControl",tab:"jSheetTab",tabContainer:"jSheetTabContainer"},cl:{sheet:"jSheet",barTop:"jSheetBarTop",barTopParent:"jSheetBarTopParent",barLeft:"jSheetBarLeft",barLeftParent:"jSheetBarLeftParent",barCorner:"jSheetBarCorner",barCornerParent:"jSheetBarCornerParent",pane:"jSheetEditPane",cell:"jSheetCellActive",barSelected:"jSheetBarItemSelected",uiDefault:"ui-state-default",uiActive:"ui-state-active",uiBase:"ui-widget-content",uiParent:"ui-widget-content ui-corner-all",uiBar:"ui-widget-header",uiPane:"ui-widget-content",uiMenuUl:"ui-widget-header",uiMenuLi:"ui-widget-header",uiMenuHighlighted:"ui-state-highlight",uiControl:"ui-widget-header ui-corner-top",uiControlTextBox:"ui-widget-content",uiCell:"themeRoller_activeCell",uiCellHighlighted:"ui-state-highlight",tableControl:"tableControl",toggle:"cellStyleToggle",tab:"jSheetTab",barTopTd:"barTop",barLeftTd:"barLeft",sheetPaneTd:"sheetPane"},controlFactory:{addRowMulti:function(b){if(!b){b=prompt("How many rows would you like to add?")}if(b){for(var a=0;a<=b;a++){jS.controlFactory.addRow()}}jS.setTdIds()},addColumnMulti:function(b){if(!b){b=prompt("How many columns would you like to add?")}if(b){for(var a=0;a<=b;a++){jS.controlFactory.addColumn()}}jS.setTdIds()},addRow:function(g,f,c){if(!c){if(!g&&jS.rowLast>-1){c=":eq("+jS.rowLast+")"}else{if(!g||jS.cellLast.row<1){c=":last";g=false}else{if(g===true){c=":eq("+(jS.cellLast.row-1)+")"}else{c=":eq("+(g-1)+")"}}}}jS.evt.cellEditAbandon();var e=jS.obj.sheet().find("tr"+c);var d=e.clone();d.find("td").andSelf().height(jS.attrH.height(e.find("td:first"),true));jQuery(d).find("td").html("").attr("class","").removeAttr("formula").keydown(function(h){return jS.evt.formulaKeyDown(h,true)});if(f){d.insertBefore(e)}else{d.insertAfter(e)}var b=jS.obj.barLeft().find("div"+c);var a=b.clone();jS.themeRoller.newBar(a);a.html(parseInt(b.text())+1).removeClass(jS.cl.uiActive).height(jS.attrH.height(d));if(f){a.insertBefore(b)}else{a.insertAfter(b)}if(g||c){jS.obj.barLeft().find("div").each(function(h){jQuery(this).text(h+1)})}jS.setTdIds();jS.obj.pane().scroll()},addColumn:function(m,h,f){if(!f){if(!m&&jS.colLast>-1){m=":eq("+jS.colLast+")"}else{if(!m||jS.cellLast.col<1){m=":last"}else{if(m===true){m=":eq("+(jS.cellLast.col-1)+")"}else{m=":eq("+(m-1)+")"}}}}else{m=f}jS.evt.cellEditAbandon();var g=jS.obj.barTop().find("div"+m);var b=jS.obj.sheet().find("col"+m);var i=g.clone().width(jS.s.newColumnWidth-jS.attrH.boxModelCorrection());var c=b.clone().width(jS.s.newColumnWidth);var e=jQuery("<td></td>");var k=cE.columnLabelIndex(g.text());var a=cE.columnLabelString(k+1);jS.log("New Column: "+k+", "+a);if(h){b.before(c);g.before(i)}else{b.after(c);g.after(i)}var d=0;var l;if(h){l=function(j){jQuery(j).find("td"+m).before(e.clone())}}else{l=function(j){jQuery(j).find("td"+m).after(e.clone())}}jS.obj.sheet().find("tr").each(function(j){l(this);d++});if(m){jS.obj.barTop().find("div").each(function(j){jQuery(this).text(cE.columnLabelString(j+1))})}jS.attrH.syncSheetWidthFromTds();jS.setTdIds();jS.obj.pane().scroll()},barLeft:function(c,d){jS.obj.barLeft().remove();var a=jQuery('<div border="1px" id="'+jS.id.barLeft+jS.i+'" class="'+jS.id.barLeft+'" />').height("10000px");var b;if(c){b=function(e,f,g){g.height(parseInt(f.outerHeight())-jS.attrH.boxModelCorrection())}}else{b=function(e,f,g){g.height(parseInt(f.css("height").replace("px",""))-jS.attrH.boxModelCorrection())}}jS.evt.barMouseDown.height(a);d.find("tr").each(function(e){var f=jQuery("<div>"+(e+1)+"</div>");jQuery(a).append(f);b(e,jQuery(this),f)});a.appendTo(jS.obj.barLeftParent())},barTop:function(c,d){jS.obj.barTop().remove();var b=jQuery('<div id="'+jS.id.barTop+jS.i+'" class="'+jS.id.barTop+'" />').width("10000px");b.height(jS.s.colMargin);var a;var e;if(c){a=d.find("tr:first td");e=function(f){return jS.attrH.width(f)}}else{a=d.find("col");e=function(f){return parseInt(jQuery(f).css("width").replace("px",""))-jS.attrH.boxModelCorrection()}}jS.evt.barMouseDown.width(b);a.each(function(h){var g=cE.columnLabelString(h+1);var f=e(this);var j=jQuery("<div>"+g+"</div>").width(f).height(jS.s.colMargin);b.append(j)});jS.obj.barTopParent().append(b)},header:function(){jS.obj.controls().remove();jS.obj.tabContainer().remove();var d=jQuery('<div id="'+jS.id.controls+'"></div>');var c=jQuery('<table cellpadding="0" cellspacing="0" border="0"><tr /></table>').prependTo(d);var b=jQuery("<tr />");if(jS.s.title){b.append(jQuery('<td style="width: auto;text-align: center;" />').html(jS.s.title))}if(jS.s.inlineMenu&&jS.s.editable){b.append(jQuery('<td style="text-align: center;" />').html(jS.s.inlineMenu))}if(jS.s.editable){if(jQuery.mbMenu){jQuery("<div />").load(jS.s.urlMenu,function(e){jQuery('<td style="width: 50px; text-align: center;" id="'+jS.id.menu+'" class="rootVoices ui-corner-tl" />').html(e).prependTo(b).buildMenu({menuWidth:100,openOnRight:false,containment:jS.s.parent.id,hasImages:false,fadeInTime:0,fadeOutTime:0,adjustLeft:2,minZindex:"auto",adjustTop:10,opacity:0.95,shadow:false,closeOnMouseOut:true,closeAfter:1000}).hover(function(){jQuery(this).addClass("ui-state-highlight")},function(){jQuery(this).removeClass("ui-state-highlight")})}).hover(function(){jQuery(this).addClass("ui-state-highlight")},function(){})}var a=jQuery('<table cellpadding="0" cellspacing="0" border="0"><tr><td style="width: 35px; text-align: right;" id="'+jS.id.label+'"></td><td style="width: 10px;" id="'+jS.id.fx+'">fx</td><td><textarea id="'+jS.id.formula+'"></textarea></td></tr></table>').appendTo(d);a.keydown(function(f){return jS.evt.formulaKeyDown(f)})}b.appendTo(c);jS.obj.parent().html("").append(d).append('<div id="'+jS.id.ui+'" class="'+jS.id.ui+'">').after('<div id="'+jS.id.tabContainer+'">'+(jS.s.editable?'<span class="ui-widget-header ui-corner-bottom" title="Add a spreadsheet" onclick="jS.addSheet();">+</span>':"<span />")+"</div>")},sheet:function(j){if(!j){j=jS.s.buildSheet}j=j.toLowerCase().split("x");var b=parseInt(j[0]);var e=parseInt(j[1]);var h=jQuery('<table border="1px" class="'+jS.cl.sheet+'" id="'+jS.id.sheet+jS.i+'"></table>');var a="<td> </td>";var c="";for(var d=b;d>=1;d--){c+=a}var g='<tr height="'+jS.s.colMargin+'" style="height: '+jS.s.colMarg+';">'+c+"</tr>";var f="";for(var d=e;d>=1;d--){f+=g}h.html("<tbody>"+f+"</tbody>");h.width(b*jS.s.newColumnWidth);return h},sheetUI:function(d,b,c,e){if(!b){jQuery(".tableControl").remove();jS.sheetCount=0;jS.i=0}else{jS.sheetCount++;jS.i=jS.sheetCount;b=jS.i}var a=jS.controlFactory.table(true).appendTo(jS.obj.ui());jS.obj.pane().html(d);jS.tuneTableForSheetUse(d);jS.sheetDecorate(d);jS.controlFactory.barTop(e,d);jS.controlFactory.barLeft(e,d);jS.sheetTab(true);if(jS.s.editable){d.mousedown(jS.evt.cellOnMouseDown).click(jS.s.lockFormulas?jS.evt.cellOnClickLocked:jS.evt.cellOnClickReg)}jS.themeRoller.start(b);jS.setTdIds(d);jS.evt.scrollBars();jS.addTab();if(c){c()}jS.log("Sheet Initialized");jS.s.fnAfter();return a},table:function(){return jQuery('<table cellpadding="0" cellspacing="0" border="0" id="'+jS.id.tableControl+jS.i+'" class="'+jS.cl.tableControl+' ui-corner-bottom"><tbody><tr><td id="'+jS.id.barCornerParent+jS.i+'" class="'+jS.cl.barCornerParent+'"><div style="height: '+jS.s.colMargin+"; width: "+jS.s.colMargin+';" id="'+jS.id.barCorner+jS.i+'" class="'+jS.cl.barCorner+'" onClick="jS.cellSetActiveAll();" title="Select All">&nbsp;</div></td><td class="'+jS.cl.barTopTd+'"><div id="'+jS.id.barTopParent+jS.i+'" class="'+jS.cl.barTopParent+'"></div></td></tr><tr><td class="'+jS.cl.barLeftTd+'"><div style="width: '+jS.s.colMargin+';" id="'+jS.id.barLeftParent+jS.i+'" class="'+jS.cl.barLeftParent+'"></div></td><td class="'+jS.cl.sheetPaneTd+'"><div id="'+jS.id.pane+jS.i+'" class="'+jS.cl.pane+'"></div></td></tr></tbody></table>')},chart:function(e,b,g,j,i,c,k){if(jGCharts){var d=new jGCharts.Api();function f(h){var l=new Array();jQuery(h).each(function(m){l[m]=jS.manageHtmlToText(h[m]+"")});return l}var a={};if(e){a.type=e}if(b){b=b.filter(function(h){return(h?h:0)});a.data=b}if(g){a.legend=f(g)}if(j){a.axis_labels=f(j)}if(i||c){a.size=i+"x"+c}return jS.controlFactory.safeImg(d.make(a),k)}else{return jQuery("<div>Charts are not enabled</div>")}},safeImg:function(b,a){return jQuery("<img />").hide().load(function(){jQuery(this).fadeIn(function(){jQuery(this).addClass("safeImg");jS.attrH.setHeight(parseInt(a),"cell",false)})}).attr("src",b)}},sizeSync:{},evt:{keyDownHandler:{enterOnTextArea:function(a){if(!a.shiftKey){return jS.evt.cellClick(key.DOWN)}else{return true}},enter:function(a){if(!jS.cellLast.isEdit&&!a.ctrlKey){return jS.evt.cellClick()}else{return jS.evt.cellClick(key.DOWN)}},tab:function(a){if(a.shiftKey){return jS.evt.cellClick(key.LEFT)}else{return jS.evt.cellClick(key.RIGHT)}},textAreaKeyDown:function(a){switch(a.keyCode){case key.ENTER:return jS.evt.keyDownHandler.enterOnTextArea(a);break;case key.TAB:return jS.evt.keyDownHandler.tab(a);break}},formulaKeyDown:function(a){switch(a.keyCode){case key.ESCAPE:jS.evt.cellEditAbandon();break;case key.TAB:return jS.evt.keyDownHandler.tab(a);break;case key.ENTER:return jS.evt.keyDownHandler.enter(a);break;case key.LEFT:case key.UP:case key.RIGHT:case key.DOWN:return jS.evt.cellClick(a.keyCode);break;default:jS.cellLast.isEdit=true}}},formulaKeyDown:function(b,a){return(a?jS.evt.keyDownHandler.textAreaKeyDown(b):jS.evt.keyDownHandler.formulaKeyDown(b))},cellEditDone:function(h){switch(jS.cellLast.isEdit){case true:var e=jS.cellLast.td;var m=false;if(e&&e.hasClass(jS.cl.cell)){var q=jS.cellTextArea(e,true);var p=false;var j=false;var b=false;var a=false;var o=false;var i=false;var d=false;var l=false;var k=false;var n=false;var g=e.attr("formula");var f=e.attr("prevVal");if(q){if(q.charAt(0)=="="){if(q!=g){a=true;jS.log("edit, new formula, possibly had formula")}else{if(g){p=true;jS.log("no edit, has formula")}else{jS.log("no edit, has formula, unknown action")}}}else{if(g){i=true;jS.log("edit, new value, had formula")}else{if(!isNaN(parseInt(q))){if((q!=f&&q!=jS.obj.formula().val())||(e.text()!=q)){k=true;jS.log("edit, from number to number, possibly in function")}else{j=true;jS.log("no edit, is a number")}}else{d=true;jS.log("possible edit from textarea, has value")}}}}else{if(e.html().length>0&&g){o=true;jS.log("edit, null value from formula")}else{if(e.html().length>0&&g){l=true;jS.log("edit, null value from formula")}else{b=true;jS.log("no edit, null value")}}}e.removeAttr("prevVal");var c=jS.manageTextToHtml(q);if(p){e.html(f)}else{if(a){m=true;e.attr("formula",q.replace(/\n/g," ")).html("")}else{if(o){m=true;e.removeAttr("formula").html(c)}else{if(i){m=true;e.removeAttr("formula").html(c)}else{if(d){e.html(c)}else{if(j){e.html(c)}else{if(b){e.html(c)}else{if(k){m=true;e.html(c)}else{if(l){m=true;e.removeAttr("formula").html("")}}}}}}}}}if(m){jS.calc(jS.i)}if(h!=false){jS.sheetClearActive()}jS.attrH.setHeight(jS.cellLast.row,"cell");jS.obj.formula().focus().select();jS.cellLast.isEdit=false}break;default:jS.attrH.setHeight(jS.cellLast.row,"cell",false);jS.sheetClearActive()}},cellEditAbandon:function(b){jS.themeRoller.clearCell();jS.themeRoller.clearBar();if(!b){var a=jS.cellTextArea(jS.cellLast.td,true);if(a){jS.cellLast.td.html(jS.manageTextToHtml(a));jS.sheetClearActive();if(a.charAt(0)=="="){jS.calc(jS.i)}}else{jS.sheetClearActive();jS.calc(jS.i)}}jS.cellLast.td=jS.obj.sheet().find("td:first");jS.cellLast.row=jS.cellLast.col=0;0;jS.rowLast=jS.colLast=-1;jS.fxUpdate("",true);return false},cellClick:function(c){var b=0;var a=0;switch(c){case key.UP:a--;break;case key.DOWN:a++;break;case key.LEFT:b--;break;case key.RIGHT:b++;break}jQuery(jS.getTd(jS.i,jS.cellLast.row+a,jS.cellLast.col+b)).click();return false},cellOnMouseDown:function(a){if(a.altKey){jS.cellSetActiveMulti(a);jQuery(document).mouseup(function(){jQuery(this).unbind("mouseup");var b=jS.obj.formula().val();jS.obj.formula().val(b+jS.getTdRange())})}else{jS.cellSetActiveMulti(a)}},cellOnClickLocked:function(a){if(!isNaN(a.target.cellIndex)){if(!jQuery(a.target).attr("formula")){jS.evt.cellOnClickManage(jQuery(a.target))}}else{jS.evt.cellEditAbandon();jS.obj.formula().focus().select()}},cellOnClickReg:function(b){if(!isNaN(b.target.cellIndex)){jS.evt.cellOnClickManage(jQuery(b.target))}else{var a=jQuery(b.target).hasClass("clickable");if(!a){jS.obj.formula().focus().select()}else{}}},cellOnClickManage:function(a){if(!a.hasClass(jS.cl.cell)){jS.cellEdit(a);jS.log("click cell")}else{jS.cellLast.isEdit=jS.isSheetEdit=true;jS.cellTextArea(a,false,true);jS.log("click, textarea over table activated")}jS.followMe(a)},resizeBar:function(c,d){var b=jQuery(c.target);var a={start:function(f){jS.log("start resize");d.offset=b.offset();d.tdPageXY=[d.offset.left,d.offset.top][d.xyDimension];d.startXY=[f.pageX,f.pageY][d.xyDimension];d.i=d.getIndex(b);d.srcBarSize=d.getSize(b);d.edgeDelta=d.startXY-(d.tdPageXY+d.srcBarSize);d.min=10;if(jS.s.joinedResizing){d.resizeFn=function(e){d.setDesinationSize(e);d.setSize(b,e)}}else{d.resizeFn=function(e){d.setSize(b,e)}}if(Math.abs(d.edgeDelta)<=d.min){jQuery(f.target).parent().css("cursor",d.cursor);jQuery(document).mousemove(a.drag).mouseup(a.stop);return true}else{return false}},drag:function(h){var g=d.min;var f=d.srcBarSize+([h.pageX,h.pageY][d.xyDimension]-d.startXY);if(f>0){g=Math.max(f,d.min)}d.resizeFn(g);return false},stop:function(f){d.setDesinationSize(d.getSize(b));jQuery(document).unbind("mousemove").unbind("mouseup");jS.obj.formula().focus().select();b.parent().css("cursor","pointer");jS.log("stop resizing")}};return a.start(c)},scrollBars:function(a){var b={pane:jS.obj.pane(),barLeft:jS.obj.barLeftParent(),barTop:jS.obj.barTopParent()};jS.obj.pane().scroll(function(){b.barTop.scrollLeft(b.pane.scrollLeft());b.barLeft.scrollTop(b.pane.scrollTop())})},barMouseDown:{select:function(c,b,f,a){var d=jS.evt.resizeBar(b,a);if(!d){f(b.target);c.unbind("mouseover").mouseover(function(g){f(g.target,true)}).mouseup(function(){c.unbind("mouseover").unbind("mouseup")})}return false},first:0,last:0,height:function(b){var a=function(){};b.unbind("mousedown").mousedown(function(c){jS.evt.barMouseDown.first=jS.evt.barMouseDown.last=jS.rowLast=jS.getBarLeftIndex(c.target);jS.evt.barMouseDown.select(b,c,a,jS.rowResizer);return false});if(jS.s.editable){a=function(e,c){if(!c){jS.themeRoller.clearCell();jS.themeRoller.clearBar()}var d=jS.getBarLeftIndex(e);jS.rowLast=d;jS.evt.barMouseDown.last=(d>jS.evt.barMouseDown.last?d:jS.evt.barMouseDown.last);jS.fxUpdate((jS.evt.barMouseDown.first+1)+":"+(jS.evt.barMouseDown.last+1),true);jS.cellSetActiveMultiRow(jS.evt.barMouseDown.last)}}},width:function(b){var a=function(){};b.unbind("mousedown").mousedown(function(c){jS.evt.barMouseDown.first=jS.evt.barMouseDown.last=jS.colLast=jS.getBarTopIndex(c.target);jS.evt.barMouseDown.select(b,c,a,jS.columnResizer);return false});if(jS.s.editable){a=function(e,c){if(!c){jS.themeRoller.clearCell();jS.themeRoller.clearBar()}var d=jS.getBarTopIndex(e);jS.colLast=d;jS.evt.barMouseDown.last=(d>jS.evt.barMouseDown.last?d:jS.evt.barMouseDown.last);jS.fxUpdate(cE.columnLabelString(jS.evt.barMouseDown.first+1)+":"+cE.columnLabelString(jS.evt.barMouseDown.last+1),true);jS.cellSetActiveMultiColumn(jS.evt.barMouseDown.last)}}}}},tuneTableForSheetUse:function(a){a.addClass(jS.cl.sheet).attr("id",jS.id.sheet+jS.i).attr("border","1px");a.find("."+jS.cl.uiCell).removeClass(jS.cl.uiCell);a.find("td").css("background-color","").css("color","").css("height","").attr("height","")},attrH:{width:function(b,a){return jQuery(b).outerWidth()-jS.attrH.boxModelCorrection(a)},widthReverse:function(b,a){return jQuery(b).outerWidth()+jS.attrH.boxModelCorrection(a)},height:function(b,a){return jQuery(b).outerHeight()-jS.attrH.boxModelCorrection(a)},heightReverse:function(b,a){return jQuery(b).outerHeight()+jS.attrH.boxModelCorrection(a)},syncSheetWidthFromTds:function(b){var a=0;b=(b?b:jS.obj.sheet());b.find("tr:first").find("td").each(function(){a+=jQuery(this).width()});b.width(a)},boxModelCorrection:function(b){var a=0;if(jQuery.support.boxModel&&!b){a=jS.s.boxModelCorrection}return a},setHeight:function(b,g,e,f){var a=0;var d=0;var c;switch(g){case"cell":f=(f?f:jS.obj.barLeft().find("div").eq(b));d=jS.attrH.height(jQuery(jS.getTd(jS.i,b,0)).parent().andSelf(),e);break;case"bar":f=(f?f:jQuery(jS.getTd(jS.i,b,0)).parent().andSelf());d=jS.attrH.heightReverse(jS.obj.barLeft().find("div").eq(b),e);break}if(d){jQuery(f).height(d).css("height",d).attr("height",d)}return f}},setTdIds:function(a){a=(a?a:jS.obj.sheet());a.find("tr").each(function(b){jQuery(this).find("td").each(function(c){jQuery(this).attr("id",jS.getTdId(jS.i,b,c))})})},columnResizer:{xyDimension:0,getIndex:function(a){return jS.getBarTopIndex(a)},getSize:function(a){return jS.attrH.width(a,true)},setSize:function(b,a){b.width(a)},setDesinationSize:function(a){jS.sheetSyncSizeToDivs();jS.obj.sheet().find("col").eq(this.i).width(a).css("width",a).attr("width",a);jS.obj.pane().scroll()},cursor:"w-resize"},rowResizer:{xyDimension:1,getIndex:function(a){return jS.getBarLeftIndex(a)},getSize:function(a){return jS.attrH.height(a,true)},setSize:function(b,a){if(a){b.height(a).css("height",a).attr("height",a)}return jS.attrH.height(b)},setDesinationSize:function(){jS.attrH.setHeight(this.i,"bar",true);jS.attrH.setHeight(this.i,"cell",false);jS.obj.pane().scroll()},cursor:"s-resize"},toggleHide:{row:function(a){if(!a){a=jS.obj.cell().parent().attr("rowIndex")}if(a){var b=jS.obj.barLeft().find("div").eq(a);if(b.is(":visible")){b.hide();jS.obj.sheet().find("tr").eq(a).hide()}else{b.show();jS.obj.sheet().find("tr").eq(a).show()}}else{alert("No row selected.")}},rowAll:function(){jS.obj.sheet().find("tr").show();jS.obj.barLeft().find("div").show()},column:function(a){if(!a){a=jS.obj.cell().attr("cellIndex")}if(a){var b=jS.obj.barTop().find("div").eq(a);if(b.is(":visible")){jS.obj.sheet().find("tbody tr").each(function(){jQuery(this).find("td").eq(a).hide()});b.hide();jS.obj.sheet().find("colgroup col").eq(a).hide();jS.toggleHide.columnSizeManage()}}else{alert("Now column selected.")}},columnAll:function(){},columnSizeManage:function(){var a=jS.obj.barTop().width();var b=0;var b=0;jS.obj.barTop().find("div").each(function(){var c=jQuery(this);if(c.is(":hidden")){b+=c.width()}});jS.obj.barTop().width(a);jS.obj.sheet().width(a)}},addTab:function(){jQuery('<span class="ui-corner-bottom ui-widget-header"><a class="'+jS.cl.tab+'" id="'+jS.id.tab+jS.i+'" OnDblClick="jS.sheetTab(); return false;" onclick="jS.setActiveSheet(jQuery(\'#'+jS.id.tableControl+jS.i+"'), "+jS.i+"); jS.calc("+jS.i+'); return false;">'+jS.sheetTab(true)+"</a></span>").insertBefore(jS.obj.tabContainer().find("span:last"))},sheetDecorate:function(a){jS.formatSheet(a);jS.sheetSyncSizeToCols(a);jS.sheetDecorateRemove()},formatSheet:function(b){if(b.find("tbody").length<1){b.wrapInner("<tbody />")}if(b.find("colgroup").length<1||b.find("col").length<1){b.remove("colgroup");var a=jQuery("<colgroup />");b.find("tr:first").find("td").each(function(){jQuery("<col />").width(jS.s.newColumnWidth).css("width",jS.s.newColumnWidth+"px").attr("width",jS.s.newColumnWidth+"px").appendTo(a)});b.find("tr").each(function(){jQuery(this).height(jS.s.colMargin).css("height",jS.s.colMargin+"px").attr("height",jS.s.colMargin+"px")});a.prependTo(b)}},themeRoller:{start:function(){jS.obj.parent().addClass(jS.cl.uiParent);jS.obj.sheet().addClass(jS.cl.uiParent);jS.obj.barLeft().find("div").addClass(jS.cl.uiBar);jS.obj.barTop().find("div").addClass(jS.cl.uiBar);jS.obj.barCornerParent().addClass(jS.cl.uiBar);jS.obj.controls().addClass(jS.cl.uiControl);jS.obj.fx().addClass(jS.cl.uiControl);jS.obj.label().addClass(jS.cl.uiControl);jS.obj.formula().addClass(jS.cl.uiControlTextBox)},cell:function(a){jS.themeRoller.clearCell();if(a){jQuery(a).addClass(jS.cl.uiCellHighlighted).addClass(jS.cl.uiCell)}},clearCell:function(){jS.obj.uiActive().removeClass(jS.cl.uiActive);jS.obj.uiCell().removeAttr("style").removeClass(jS.cl.uiCellHighlighted).removeClass(jS.cl.uiCell)},newBar:function(a){jQuery(a).addClass(jS.cl.uiBar)},barTop:function(a){jS.obj.barTop().find("div").eq(a).addClass(jS.cl.uiActive)},barLeft:function(a){jS.obj.barLeft().find("div").eq(a).addClass(jS.cl.uiActive)},barObj:function(a){jQuery(a).addClass(jS.cl.uiActive)},clearBar:function(){jS.obj.barTop().find("."+jS.cl.uiActive).removeClass(jS.cl.uiActive);jS.obj.barLeft().find("."+jS.cl.uiActive).removeClass(jS.cl.uiActive)},resize:function(){if(jQuery.ui){var f;var e;var b;var c;var d=jQuery(jS.s.parent);d.resizable("destroy").resizable({minWidth:jS.s.width*0.5,minHeight:jS.s.height*0.5,ghost:true,stop:function(){jS.s.width=d.width();jS.s.height=d.height();jS.sheetSyncSize()}});var a=jQuery("<span />");jS.obj.formula().wrap(a).parent().resizable({minHeight:jS.obj.formula().height(),maxHeight:78,handles:"s",resize:function(h,g){jS.obj.formula().height(g.size.height);jS.sheetSyncSize()}})}}},manageHtmlToText:function(a){a=jQuery.trim(a);if(a.charAt(0)!="="){a=a.replace(/&nbsp;/g," ").replace(/&gt;/g,">").replace(/&lt;/g,"<").replace(/\t/g,"").replace(/\n/g,"").replace(/<br>/g,"\r").replace(/<BR>/g,"\n")}return a},manageTextToHtml:function(a){a=jQuery.trim(a);if(a.charAt(0)!="="){a=a.replace(/\t/g,"&nbsp;&nbsp;&nbsp;&nbsp;").replace(/ /g,"&nbsp;").replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/\n/g,"<br>").replace(/\r/g,"<br>")}return a},sheetDecorateRemove:function(b){var a=(b?jS.obj.sheetAll().clone():jS.obj.sheetAll());jQuery(a).find("."+jS.cl.cell).removeClass(jS.cl.cell);jQuery(a).find("."+jS.cl.uiCellHighlighted).removeClass(jS.cl.uiCellHighlighted);jQuery(a).find("."+jS.cl.uiCell).removeClass(jS.cl.uiCell);jQuery(a).find("col").each(function(d){var c=jQuery(this).css("width");c=((c+"").match("px")?c:c+"px");jQuery(a).find("col").eq(d).attr("width",c)});return a},fxUpdate:function(b,a){if(!a){jS.obj.label().html(cE.columnLabelString(b[1]+1)+(b[0]+1))}else{jS.obj.label().html(b)}},cellEdit:function(c){jS.evt.cellEditDone();var b=jS.getTdLocation(c);jS.fxUpdate(b);var a=c.attr("formula");if(!a){a=jS.manageHtmlToText(c.html())}jS.obj.formula().val(a).focus().select();jS.cellSetActive(c,b)},cellSetActive:function(b,a){jS.cellLast.td=b;jS.cellLast.row=jS.rowLast=a[0];jS.cellLast.col=jS.colLast=a[1];jS.themeRoller.cell(b);jS.themeRoller.barLeft(jS.cellLast.row);jS.themeRoller.barTop(jS.cellLast.col);b.addClass(jS.cl.cell);jS.obj.barLeft().find("div").eq(jS.cellLast.row).addClass(jS.cl.barSelected);jS.obj.barTop().find("div").eq(jS.cellLast.col).addClass(jS.cl.barSelected)},colLast:-1,rowLast:-1,cellLast:{td:null,row:null,col:null,isEdit:false},cellStyleToggle:function(b,a){if(a){a=a.split(",");jQuery(a).each(function(){jS.obj.uiCell().removeClass(this)})}if(jS.obj.uiCell().hasClass(b)){jS.obj.uiCell().removeClass(b)}else{jS.obj.uiCell().addClass(b)}jS.obj.formula().focus().select();return false},context:{},calc:function(b,a){jS.log("Calculation Started");if(!jS.s.calcOff){cE.calc(new jS.tableCellProvider(b),jS.context,a);jS.isSheetEdit=false}jS.log("Calculation Ended")},cellTextArea:function(i,d,a,e){var b;if(i){if(!a){var g=i.find("textarea");var f=g.val();if(f||jS.obj.formula().attr("disabled")){jS.log("Textarea value used");b=f;g.remove()}else{jS.log("Formula value used");b=jS.obj.formula().val()}jS.obj.formula().removeAttr("disabled")}else{if(e){b=e}else{b=jS.obj.formula().val()}jS.obj.formula().attr("disabled","true");var g=jQuery('<textarea id="tempText" />');var c=jS.attrH.height(i);i.parent().height(c+jS.attrH.boxModelCorrection());g.height(c<75?75:c).val(b).click(function(){return false}).keydown(function(h){return jS.evt.formulaKeyDown(h,true)});if(i.attr("formula")){i.attr("prevVal",i.text()).removeAttr("formula")}i.html(g);g.focus().select()}if(d){return b}}},refreshLabelsColumns:function(){var a=0;jS.obj.barTop().find("div").each(function(b){jQuery(this).text(cE.columnLabelString(b+1));a+=jQuery(this).width()});return a},refreshLabelsRows:function(){jS.obj.barLeft().find("div").each(function(a){jQuery(this).text((a+1))})},addSheet:function(a){a=(a?a:prompt(jS.newSheetDialog));if(a){jS.evt.cellEditAbandon();jS.setDirty(true);var b=jS.controlFactory.sheetUI(jS.controlFactory.sheet(a),jS.sheetCount+1,function(){jS.setActiveSheet(b,jS.sheetCount+1)},true)}},deleteRow:function(){var a=confirm("Are you sure that you want to delete that row? Fomulas will not be updated.");if(a){jS.obj.barLeft().find("div").eq(jS.rowLast).remove();jS.obj.sheet().find("tr").eq(jS.rowLast).remove();jS.evt.cellEditAbandon();jS.setTdIds();jS.refreshLabelsRows();jS.obj.pane().scroll();jS.rowLast=-1}},deleteColumn:function(){var b=confirm("Are you sure that you want to delete that column? Fomulas will not be updated.");if(b){jS.obj.barTop().find("div").eq(jS.colLast).remove();jS.obj.sheet().find("colgroup col").eq(jS.colLast).remove();jS.obj.sheet().find("tr").each(function(c){jQuery(this).find("td").eq(jS.colLast).remove()});jS.evt.cellEditAbandon();var a=jS.refreshLabelsColumns();jS.setTdIds();jS.obj.sheet().width(a);jS.obj.pane().scroll();jS.colLast=-1}},sheetTab:function(b){var a="";if(b){a=jS.obj.sheet().attr("title");a=(a?a:"Spreadsheet "+(jS.i+1))}else{var c=prompt("What would you like the sheet's title to be?",jS.sheetTab(true));if(!c){a=jS.obj.sheet().attr("title");c=(a?a:"Spreadsheet"+(jS.i+1))}else{jS.setDirty(true);jS.obj.sheet().attr("title",c);jS.obj.tab().html(c);a=c}}return a},print:function(b){var a=window.open();a.document.write("<html><body><xmp>"+b+"\n</xmp></body></html>");a.document.close()},viewSource:function(b){var c=jS.sheetDecorateRemove(true);var a="";if(b){jQuery(c).each(function(){a+=jS.HTMLtoPrettySource(this)})}else{a+=jQuery("<div />").html(c).html()}jS.print(a);return false},saveSheet:function(){var a=jS.sheetDecorateRemove(true);var b=jQuery("<div />").html(a).html();jQuery.ajax({url:jS.s.urlSave,type:"POST",data:"s="+b,dataType:"html",success:function(c){jS.setDirty(false);alert("Success! - "+c)}})},HTMLtoCompactSource:function(f){var b="";if(f.nodeType==1){b+="<"+f.tagName;d=false;var h=f.attributes.length;for(var e=0,d=false;e<h;e++){var c=f.attributes[e].name;var g=f.getAttribute(c);if(g){if(c=="contentEditable"&&g=="inherit"){continue}if(c=="class"){d=true;jQuery(g).removeClass(jS.cl.cell)}if(typeof(g)=="string"){b+=" "+c+'="'+g.replace(/"/g,"'")+'"'}else{if(c=="style"&&g.cssText){b+=' style="'+g.cssText+'"'}}}}if(f.tagName=="TABLE"&&!d){b+=' class="jSheet"'}if(f.tagName=="COL"){b+="/>"}else{b+=">";var a="";jQuery(f.childNodes).each(function(){a+=jS.HTMLtoCompactSource(this)});b+=a;b+="</"+f.tagName+">"}}else{if(f.nodeType==3){b+=f.data.replace(/^\s*(.*)\s*$/g,"$1")}}return b},HTMLtoPrettySource:function(e,f){if(!f){f=""}var b="";if(e.nodeType==1){b+="\n"+f+"<"+e.tagName;var h=e.attributes.length;for(var d=0;d<h;d++){var c=e.attributes[d].name;var g=e.getAttribute(c);if(g){if(c=="contentEditable"&&g=="inherit"){continue}if(typeof(g)=="string"){b+=" "+c+'="'+g.replace(/"/g,"'")+'"'}else{if(c=="style"&&g.cssText){b+=' style="'+g.cssText+'"'}}}}if(e.childNodes.length<=0){b+="/>"}else{b+=">";var a="";var h=e.childNodes.length;for(var d=0;d<h;d++){a+=jS.HTMLtoPrettySource(e.childNodes[d],f+"  ")}b+=a;if(a.indexOf("\n")>=0){b+="\n"+f}b+="</"+e.tagName+">"}}else{if(e.nodeType==3){b+=e.data.replace(/^\s*(.*)\s*$/g,"$1")}}return b},followMe:function(a){jS.obj.pane().stop().scrollTo(a,{margin:true,axis:"xy",duration:100,offset:{top:-jS.s.height/3,left:-jS.s.width/5}})},count:{rows:function(){return jS.getBarLeftIndex(jS.obj.barLeft().find("div:last").text())},columns:function(){return jS.getBarTopLocatoin(jS.obj.barTop().find("div:last").text())}},setActiveSheet:function(b,a){if(b){b.show().siblings().hide();jS.obj.tabContainer().find(".ui-state-highlight").removeClass("ui-state-highlight");jS.i=a;jS.obj.tab().parent().addClass("ui-state-highlight")}else{jS.obj.tableControl().siblings().not("div").hide();jS.obj.tabContainer().find(".ui-state-highlight").removeClass("ui-state-highlight");jS.obj.tab().parent().addClass("ui-state-highlight")}jS.sheetSyncSize();jS.replaceWithSafeImg(jS.obj.sheet().find("img"))},openSheetURL:function(a){jS.s.urlGet=a;return jS.openSheet()},openSheet:function(c){if(!jS.isDirty?true:confirm("Are you sure you want to open a different sheet?  All unsaved changes will be lost.")){jS.controlFactory.header();var b=function(e,d){if(e==(d-1)){jS.i=0;jS.setActiveSheet();jS.themeRoller.resize();for(var e=0;e<=jS.sheetCount;e++){jS.calc(e)}}};if(!c){jQuery("<div />").load(jS.s.urlGet,function(){var d=jQuery(this).find("table");d.each(function(e){jS.controlFactory.sheetUI(jQuery(this),e,function(){b(e,d.length)},true)})})}else{var a=jQuery("<div />").html(c).find("table");a.each(function(d){jS.controlFactory.sheetUI(jQuery(this),d,function(){b(d,a.length)},false)})}return true}else{return false}},newSheetDialog:"What size would you like to make your spreadsheet? Example: '5x10' creates a sheet that is 5 columns by 10 rows.",newSheet:function(){var a=prompt(jS.newSheetDialog);if(a){jS.openSheet(jS.controlFactory.sheet(a))}},importRow:function(b){jS.controlFactory.addRow(null,null,":last");var a="";jS.obj.sheet().find("tr:last td").each(function(c){jQuery(this).removeAttr("formula");try{if((b[c]+"").charAt(0)=="="){jQuery(this).attr("formula",b[c])}else{jQuery(this).html(b[c])}}catch(d){a+=d+";\n"}});if(a){alert(a)}jS.setTdIds();jS.calc(jS.i)},importColumn:function(a){jS.controlFactory.addColumn();var b="";jS.obj.sheet().find("tr").each(function(c){var f=jQuery(this).find("td:last");try{if((a[c]+"").charAt(0)=="="){f.attr("formula",a[c])}else{f.html(a[c])}}catch(d){b+=d+";\n"}});if(b){alert(b)}jS.setTdIds();jS.calc(jS.i)},importSheet:{xml:function(c){var b=jQuery("<table />");var a=jQuery("<tbody />").appendTo(b);jQuery(c).find("document").each(function(){var d=jQuery(this).find("metadata");var f=d.find("columns").text();var e=d.find("rows").text();var g=d.find("title").html();jQuery(this).find("data").children().each(function(h){var j=jQuery("<tr />");jQuery(this).children().each(function(i){var k=jQuery(this).html();if(k.charAt(0)=="="){j.append('<td formula="'+k+'" />')}else{j.append("<td>"+k+"</td>")}});a.append(j)})});return b},json:function(data){jS.i=jS.sheetCount+1;sheet=eval("("+data+")");size_c=sheet.metadata["columns"]*1+5;size_r=sheet.metadata["rows"]*1+1;title=sheet.metadata["title"];title=(title?title:"");var table=jQuery("<table id='"+jS.id.sheet+jS.i+"' class='"+jS.cl.sheet+"' title='"+title+"' />");var cur_row;for(var x=1;x<=size_r;x++){cur_row=jQuery('<tr height="'+jS.s.colMargin+'px" />').appendTo(table);for(var y=1;y<=size_c;y++){cur_row.append('<td id="table'+jS.i+"_cell_c"+y+"_r"+x+'" />')}}for(row in sheet.data){for(column in sheet.data[row]){cur_val=sheet.data[row][column];cur_column=table.find("table"+jS.i+"_cell_"+column+"_r"+row).text(cur_val);if(cur_val.charAt(0)=="="){cur_column.attr("formula",cur_val)}}}return table}},exportSheet:{xml:function(){var b=jS.sheetDecorateRemove(true);var a="";jQuery(b).each(function(){var d="";var g=jQuery(this).attr("title");var e=0;var c=cur_row="";var f=max_row=0;jQuery(this).find("tr").each(function(h){e=0;max_row=h;jQuery(this).find("td").each(function(){e++;var m=jQuery(this).attr("id");var i=jQuery.trim(jQuery(this).text());var l=m.search(/cell_c/i);var j=m.search(/_r/i);if(i!=""&&l!=-1&&j!=-1){c=m.substr(l+6,j-(l+6));cur_row=m.substr(j+2);if(f<c){f=c}if(max_row<cur_row){max_row=cur_row}if(e==1){d+="<r"+cur_row+">"}var k=jQuery(this).attr("formula");if(k){i=k}d+="<c"+c+"><![CDATA["+i+"]]></c"+c+">"}});if(cur_row!=""){d+="</r"+cur_row+">"}c=cur_row=""});a+="<document><metadata><columns>"+f+"</columns><rows>"+max_row+"</rows><title>"+g+"</title></metadata><data>"+d+"</data></document>"});return"<documents>"+a+"</documents>"},json:function(){var a=jS.sheetDecorateRemove(true);var b=[];jQuery(a).each(function(){var e={metadata:{},data:{}};e.metadata.title=jQuery(this).attr("title");var d=0;var c=cur_row="";var f=max_row=0;jQuery(this).find("tr").each(function(){d=0;jQuery(this).find("td").each(function(){d++;var l=jQuery(this).attr("id");var g=jQuery.trim(jQuery(this).text());var k=l.search(/cell_c/i);var h=l.search(/_r/i);if(g!=""&&k!=-1&&h!=-1){c=l.substr(k+6,h-(k+6));cur_row=l.substr(h+2);if(f<c){f=c}if(max_row<cur_row){max_row=cur_row}if(d==1){e.data["r"+cur_row]={}}var j=jQuery(this).attr("formula");if(j){g=j}try{e.data["r"+cur_row]["c"+c]=g}catch(i){}}});c=cur_row=""});e.metadata={columns:f,rows:max_row};b.push(e)});return b},html:function(){return jS.sheetDecorateRemove(true)}},sheetSyncSizeToDivs:function(){var a=0;jS.obj.barTop().find("div").each(function(){a+=parseInt(jQuery(this).outerWidth())});jS.obj.sheet().width(a)},sheetSyncSizeToCols:function(a){var b=0;a.find("colgroup col").each(function(){b+=jQuery(this).width()});a.width(b)},sheetSyncSize:function(){var b=jS.s.height;if(!b){b=400}else{if(b<200){b=200}}jS.obj.parent().height(b);var a=jS.s.width-jS.attrH.width(jS.obj.barLeftParent())-(jS.attrH.boxModelCorrection());b=b-jS.attrH.height(jS.obj.controls())-jS.attrH.height(jS.obj.barTopParent())-(jS.attrH.boxModelCorrection()*2);jS.obj.pane().height(b).width(a).parent().width(a);jS.obj.ui().width(a+jS.attrH.width(jS.obj.barLeftParent()));jS.obj.barLeftParent().height(b);jS.obj.barTopParent().width(a).parent().width(a)},cellFind:function(a){if(!a){a=prompt("What are you looking for in this spreadsheet?")}if(a){var b=jS.obj.sheet().find('td:contains("'+a+'")');if(b.length<1){b=jS.obj.sheet().find('td:contains("'+a.toLowerCase()+'")')}if(b.length<1){b=jS.obj.sheet().find('td:contains("'+a.toUpperCase()+'")')}b=b.eq(0);if(b.length>0){b.click()}else{alert("No results found.")}}},cellSetActiveMulti:function(a){jS.themeRoller.clearCell();jS.themeRoller.clearBar();var b={startRow:a.target.parentNode.rowIndex,startColumn:a.target.cellIndex};jS.obj.sheet().mousemove(function(f){b.endRow=f.target.parentNode.rowIndex;b.endColumn=f.target.cellIndex;for(var d=b.startRow;d<=b.endRow;d++){for(var c=b.startColumn;c<=b.endColumn;c++){var g=jS.getTd(jS.i,d,c);jQuery(g).addClass(jS.cl.uiCell).addClass(jS.cl.uiCellHighlighted)}}}).mouseup(function(){jS.obj.sheet().unbind("mousemove").unbind("mouseup")});return false},cellSetActiveAll:function(){if(jS.s.editable){var a=0;var b=0;jS.obj.barLeft().find("div").each(function(c){jS.cellSetActiveMultiRow(c);a++});jS.obj.barTop().find("div").each(function(c){jS.themeRoller.barTop(c);b++});jS.fxUpdate("A1:"+cE.columnLabelString(b)+a,true)}},cellSetActiveMultiColumn:function(a){jS.obj.sheet().find("tr").each(function(){var b=jQuery(this).find("td").eq(a);b.addClass(jS.cl.uiCell).addClass(jS.cl.uiCellHighlighted)});jS.themeRoller.barTop(a)},cellSetActiveMultiRow:function(a){jS.obj.sheet().find("tr").eq(a).find("td").addClass(jS.cl.uiCell).addClass(jS.cl.uiCellHighlighted);jS.themeRoller.barLeft(a)},sheetClearActive:function(){jS.obj.formula().val("");jS.obj.cell().removeClass(jS.cl.cell);jS.obj.barSelected().removeClass(jS.cl.barSelected)},getTdRange:function(){var b=jS.obj.uiCell().not("."+jS.cl.cell);if(b.length){var c={first:jS.getTdLocation(b.first()),last:jS.getTdLocation(b.last())};c.first[0]++;c.first[1]++;c.last[0]++;c.last[1]++;var a={first:cE.columnLabelString(c.first[1])+c.first[0],last:cE.columnLabelString(c.last[1])+c.last[0]};return a.first+":"+a.last}else{return""}},getTdId:function(a,c,b){return"table"+a+"_cell_c"+b+"_r"+c},getTd:function(a,c,b){return document.getElementById(jS.getTdId(a,c,b))},getTdLocation:function(c){var a=parseInt(c[0].cellIndex);var b=parseInt(c[0].parentNode.rowIndex);return[b,a]},getBarLeftIndex:function(b){var a=jQuery.trim(jQuery(b).text());return parseInt(a)-1},getBarTopIndex:function(b){var a=cE.columnLabelIndex(jQuery.trim(jQuery(b).text()));return parseInt(a)-1},tableCellProvider:function(a){this.tableBodyId="jSheet"+a;this.tableI=a;this.cells={}},tableCell:function(a,c,b){this.tableBodyId="jSheet"+a;this.tableI=a;this.row=c;this.col=b;this.value=jS.EMPTY_VALUE},EMPTY_VALUE:{},time:{now:new Date(),last:new Date(),diff:function(){return Math.abs(Math.ceil(this.last.getTime()-this.now.getTime())/1000).toFixed(5)},set:function(){this.last=this.now;this.now=new Date()},get:function(){return this.now.getHours()+":"+this.now.getMinutes()+":"+this.now.getSeconds()}},log:function(a){jS.time.set();jS.obj.log().prepend(jS.time.get()+", "+jS.time.diff()+"; "+a+"<br />\n")},replaceWithSafeImg:function(a){a.each(function(){var b=jQuery(this).attr("src");jQuery(this).replaceWith(jS.controlFactory.safeImg(b,jS.getTdLocation(jQuery(this).parent())[0]))})},isDirty:false,setDirty:function(a){jS.isDirty=a},appendToFormula:function(a,c){var d=jS.obj.formula();if(d.attr("disabled")){d=jS.cellLast.td.find("textarea")}var b=d.val();if(b.charAt(0)!="="){b="="+b}d.val(b+a)}};jS.tableCellProvider.prototype={getCell:function(b,e,c){if(typeof(c)=="string"){c=cE.columnLabelIndex(c)}var d=b+","+e+","+c;var a=this.cells[d];if(!a){var f=jS.getTd(b,e-1,c-1);if(f){a=this.cells[d]=new jS.tableCell(b,e,c)}}return a},getNumberOfColumns:function(b){var c=document.getElementById(this.tableBodyId);if(c){var a=c.rows[b];if(a){return a.cells.length}}return 0},toString:function(){result="";jQuery("#"+(this.tableBodyId)+" tr").each(function(){result+=this.innerHTML.replace(/\n/g,"")+"\n"});return result}};jS.tableCell.prototype={getTd:function(){return document.getElementById(jS.getTdId(this.tableI,this.row-1,this.col-1))},setValue:function(a,b){this.error=b;this.value=a;jQuery(this.getTd()).html(a?a:"")},getValue:function(){var a=this.value;if(a===jS.EMPTY_VALUE&&!this.getFormula()){a=this.getTd().innerHTML;a=this.value=(a.length>0?cE.parseFormulaStatic(a):null)}return(a===jS.EMPTY_VALUE?null:a)},getFormat:function(){return jQuery(this.getTd()).attr("format")},setFormat:function(a){jQuery(this.getTd()).attr("format",a)},getFormulaFunc:function(){return this.formulaFunc},setFormulaFunc:function(a){this.formulaFunc=a},getFormula:function(){return jQuery(this.getTd()).attr("formula")},setFormula:function(a){if(a&&a.length>0){jQuery(this.getTd()).attr("formula",a)}else{jQuery(this.getTd()).removeAttr("formula")}}};var key={BACKSPACE:8,CAPS_LOCK:20,COMMA:188,CONTROL:17,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,INSERT:45,LEFT:37,NUMPAD_ADD:107,NUMPAD_DECIMAL:110,NUMPAD_DIVIDE:111,NUMPAD_ENTER:108,NUMPAD_MULTIPLY:106,NUMPAD_SUBTRACT:109,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SHIFT:16,SPACE:32,TAB:9,UP:38};var cE=jQuery.calculationEngine={TEST:{},ERROR:"#VALUE!",cFN:{sum:function(a,b){return a+b},max:function(a,b){return a>b?a:b},min:function(a,b){return a<b?a:b},count:function(a,b){return(b!=null)?a+1:a},clean:function(a){if(typeof(a)=="string"){a=a.replace(cE.regEx.amp,"&").replace(cE.regEx.nbsp," ").replace(/\n/g,"").replace(/\r/g,"")}return a},input:{select:{obj:function(){return jQuery('<select style="width: 100%;" onchange="cE.cFN.input.setValue(jQuery(this).val(), jQuery(this).parent());" class="clickable" />')}},radio:{obj:function(a){var c=jQuery('<span class="clickable" />');var b=cE.cFN.input.radio.name();for(var d=0;d<(a.length<=25?a.length:25);d++){if(a[d]){c.append('<input onchange="cE.cFN.input.setValue(jQuery(this).val(), jQuery(this).parent().parent());" type="radio" value="'+a[d]+'" name="'+b+'" />'+a[d]+"<br />")}}return c},name:function(){return"table"+cE.thisCell.tableI+"_cell_c"+(cE.thisCell.col-1)+"_r"+(cE.thisCell.row-1)+"radio"}},checkbox:{obj:function(a){return jQuery('<input onclick="cE.cFN.input.setValue(jQuery(this).is(\':checked\') + \'\', jQuery(this).parent());" type="checkbox" value="'+a+'" />'+a+"<br />")}},setValue:function(a,b){b.attr("selectedvalue",a);jS.calc(cE.calcState.i)},getValue:function(){return jQuery(jS.getTd(cE.thisCell.tableI,cE.thisCell.row-1,cE.thisCell.col-1)).attr("selectedvalue")}}},fn:{HTML:function(a){return jQuery(a)},IMG:function(a){return jS.controlFactory.safeImg(a,cE.calcState.row,cE.calcState.col)},AVERAGE:function(b){var a=cE.foldPrepare(b,arguments);return cE.fn.SUM(a)/cE.fn.COUNT(a)},AVG:function(a){return cE.fn.AVERAGE(a)},COUNT:function(a){return cE.fold(cE.foldPrepare(a,arguments),cE.cFN.count,0)},SUM:function(a){return cE.fold(cE.foldPrepare(a,arguments),cE.cFN.sum,0,true)},MAX:function(a){return cE.fold(cE.foldPrepare(a,arguments),cE.cFN.max,Number.MIN_VALUE,true)},MIN:function(a){return cE.fold(cE.foldPrepare(a,arguments),cE.cFN.min,Number.MAX_VALUE,true)},ABS:function(a){return Math.abs(cE.fn.N(a))},CEILING:function(a){return Math.ceil(cE.fn.N(a))},FLOOR:function(a){return Math.floor(cE.fn.N(a))},INT:function(a){return Math.floor(cE.fn.N(a))},ROUND:function(b,a){return cE.fn.FIXED(b,(a?a:0),false)},RAND:function(a){return Math.random()},RND:function(a){return Math.random()},TRUE:function(){return"TRUE"},FALSE:function(){return"FALSE"},NOW:function(){return new Date()},TODAY:function(){return Date(Math.floor(new Date()))},DAYSFROM:function(b,c,a){return Math.floor((new Date()-new Date(b,(c-1),a))/86400000)},IF:function(v,t,f){t=cE.cFN.clean(t);f=cE.cFN.clean(f);try{v=eval(v)}catch(e){}try{t=eval(t)}catch(e){}try{t=eval(t)}catch(e){}if(v=="true"||v==true||v>0||v=="TRUE"){return t}else{return f}},FIXED:function(g,b,h){if(b==null){b=2}var f=Math.pow(10,b);var k=String(Math.round(cE.fn.N(g)*f)/f);var a=k.indexOf(".");if(a<0){a=k.length;k+="."}for(var c=k.length-a-1;c<b;c++){k+="0"}if(h==true){return k}var e=k.replace("-","").split(".");var j=[];var d=true;while(e[0].length>0){if(!d){j.unshift(",")}j.unshift(e[0].slice(-3));e[0]=e[0].slice(0,-3);d=false}if(b>0){j.push(".");var d=true;while(e[1].length>0){if(!d){j.push(",")}j.push(e[1].slice(0,3));e[1]=e[1].slice(3);d=false}}if(g<0){return"-"+j.join("")}return j.join("")},TRIM:function(a){if(typeof(a)=="string"){a=jQuery.trim(a)}return a},HYPERLINK:function(b,a){a=(a?a:"LINK");return jQuery('<a href="'+b+'" target="_new" class="clickable">'+a+"</a>")},DOLLAR:function(b,a,d){if(a==null){a=2}if(d==null){d="$"}var c=cE.fn.FIXED(b,a,false);if(b>=0){return d+c}else{return"-"+d+c.slice(1)}},VALUE:function(a){return parseFloat(a)},N:function(a){if(a==null){return 0}if(a instanceof Date){return a.getTime()}if(typeof(a)=="object"){a=a.toString()}if(typeof(a)=="string"){a=parseFloat(a.replace(cE.regEx.n,""))}if(isNaN(a)){return 0}if(typeof(a)=="number"){return a}if(a==true){return 1}return 0},PI:function(){return Math.PI},POWER:function(a,b){return Math.pow(a,b)},INPUT:{SELECT:function(a,c){a=cE.foldPrepare(a,arguments);var d=cE.cFN.input.select.obj();if(!c){d.append('<option value="">Select a value</option>')}for(var b=0;b<(a.length<=50?a.length:50);b++){if(a[b]){d.append('<option value="'+a[b]+'">'+a[b]+"</option>")}}d.val(cE.cFN.input.getValue());return d},SELECTVAL:function(a){return jQuery(a).val()},RADIO:function(a){a=cE.foldPrepare(a,arguments);var b=cE.cFN.input.radio.obj(a);b.find('input[value="'+cE.cFN.input.getValue()+'"]').attr("CHECKED","true");return b},RADIOVAL:function(a){a=cE.foldPrepare(a,arguments);return jQuery(a).find("input:checked").val()},CHECKBOX:function(a){a=cE.foldPrepare(a,arguments)[0];var c=cE.cFN.input.checkbox.obj(a);var b=cE.cFN.input.getValue();if(b=="true"||b==true){c.attr("CHECKED","TRUE")}else{c.removeAttr("CHECKED")}return c},CHECKBOXVAL:function(a){a=cE.foldPrepare(a,arguments);return jQuery(a).val()},ISCHECKED:function(a){var b=jQuery(a).is(":checked");if(b){return"TRUE"}else{return"FALSE"}}},CHART:{BAR:function(b,e,c,a,d){return jS.controlFactory.chart(null,cE.foldPrepare(b,arguments),e,c,a,d,cE.calcState.row-1)},BARH:function(b,e,c,a,d){return jS.controlFactory.chart("bhg",cE.foldPrepare(b,arguments),e,c,a,d,cE.calcState.row-1)},SBAR:function(b,e,c,a,d){return jS.controlFactory.chart("bvs",cE.foldPrepare(b,arguments),e,c,a,d,cE.calcState.row-1)},SBARH:function(b,e,c,a,d){return jS.controlFactory.chart("bhs",cE.foldPrepare(b,arguments),e,c,a,d,cE.calcState.row-1)},LINE:function(b,e,c,a,d){return jS.controlFactory.chart("lc",cE.foldPrepare(b,arguments),e,c,a,d,cE.calcState.row-1)},PIE:function(b,e,c,a,d){return jS.controlFactory.chart("p",cE.foldPrepare(b,arguments),e,c,a,d,cE.calcState.row-1)},PIETHREED:function(b,e,c,a,d){return jS.controlFactory.chart("p3",cE.foldPrepare(b,arguments),e,c,a,d,cE.calcState.row-1)},CUSTOM:function(f,b,e,c,a,d){return jS.controlFactory.chart(f,cE.foldPrepare(b,arguments),e,c,a,d,cE.calcState.row-1)}}},calcState:{},calc:function(c,a,b){cE.calcState={cellProvider:c,context:(a!=null?a:{}),row:1,col:1,i:c.tableI,done:false,stack:[],calcMore:function(d){cE.calcState.fuel=d;return cE.calcLoop()}};return cE.calcState.calcMore(b)},cell:function(){prototype:{getError=function(){return this.error},getValue=function(){return this.value},setValue=function(a,b){this.value=a;this.error=b},getFormula=function(){return this.formula},setFormula=function(a){this.formula=a},getFormulaFunc=function(){return this.formulaFunc},setFormulaFunc=function(a){this.formulaFunc=a},toString=function(){return"Cell:["+this.getFormula()+": "+this.getValue()+": "+this.getError()+"]"}}},columnLabelIndex:function(c){var a=0;for(var b=0;b<c.length;b++){var d=c.charCodeAt(b)-65+1;a=(a*26)+d}return a},parseLocation:function(b){if(b!=null&&b.length>0&&b!="&nbsp;"){for(var a=0;a<b.length;a++){if(b.charCodeAt(a)<=57){break}}return[parseInt(b.substring(a)),cE.columnLabelIndex(b.substring(0,a))]}else{return null}},columnLabelString:function(e){var d=(e-1).toString(26).toUpperCase();var g=[];for(var f=0;f<d.length;f++){var a=d.charCodeAt(f);if(f<=0&&d.length>1){a=a-1}if(a<=57){g.push(String.fromCharCode(a-48+65))}else{g.push(String.fromCharCode(a+10))}}return g.join("")},regEx:{n:/[\$,\s]/g,cell:/\$?([a-zA-Z]+)\$?([0-9]+)/g,range:/\$?([a-zA-Z]+)\$?([0-9]+):\$?([a-zA-Z]+)\$?([0-9]+)/g,remoteCell:/\$?(SHEET+)\$?([0-9]+):\$?([a-zA-Z]+)\$?([0-9]+)/g,remoteCellRange:/\$?(SHEET+)\$?([0-9]+):\$?([a-zA-Z]+)\$?([0-9]+):\$?([a-zA-Z]+)\$?([0-9]+)/g,amp:/&/g,gt:/</g,lt:/>/g,nbsp:/&nbsp;/g},str:{amp:"&amp;",lt:"&lt;",gt:"&gt;",nbsp:"&nbps;"},parseFormula:function(e,c,a){var b=null;var d=null;if(cE.calcState.cellProvider!=null){b=cE.calcState.cellProvider.nrows;d=cE.calcState.cellProvider.ncols}e=e.replace(cE.regEx.remoteCellRange,function(i,m,s,k,h,o,j){var p=[];var g=cE.columnLabelIndex(k);var t=parseInt(h);var n=cE.columnLabelIndex(o);var l=parseInt(j);if(d!=null){n=Math.min(n,d)}if(b!=null){l=Math.min(l,b)}for(var f=t;f<=l;f++){for(var q=g;q<=n;q++){p.push("SHEET"+(s)+":"+cE.columnLabelString(q)+f)}}return"["+p.join(",")+"]"});e=e.replace(cE.regEx.remoteCell,function(h,f,g,j,i){g=parseInt(g)-1;j=j.toUpperCase();if(c!=null){c["SHEET"+(g)+":"+j+i]=[parseInt(i),cE.columnLabelIndex(j),g]}return"(cE.calcState.cellProvider.getCell(("+(g)+"),("+(i)+'),"'+(j)+'").getValue())'});e=e.replace(cE.regEx.range,function(i,k,h,n,j){var o=[];var g=cE.columnLabelIndex(k);var q=parseInt(h);var m=cE.columnLabelIndex(n);var l=parseInt(j);if(d!=null){m=Math.min(m,d)}if(b!=null){l=Math.min(l,b)}for(var f=q;f<=l;f++){for(var p=g;p<=m;p++){o.push(cE.columnLabelString(p)+f)}}return"["+o.join(",")+"]"});e=e.replace(cE.regEx.cell,function(f,h,g){h=h.toUpperCase();if(c!=null){c["SHEET"+a+":"+h+g]=[parseInt(g),cE.columnLabelIndex(h),a]}return"(cE.calcState.cellProvider.getCell(("+a+"),("+(g)+'),"'+(h)+'").getValue())'});return e},parseFormulaStatic:function(c){if(c==null){return null}else{var b=c.replace(cE.regEx.n,"");var a=parseFloat(b);if(isNaN(a)){a=parseInt(b)}if(isNaN(a)){a=(c.charAt(0)=="'"?c.substring(1):c)}return a}},calcLoop:function(){if(cE.calcState.done==true){return null}else{while(cE.calcState.fuel==null||cE.calcState.fuel>0){if(cE.calcState.stack.length>0){var a=cE.calcState.stack.pop();if(a!=null){a(cE.calcState)}}else{if(cE.calcState.cellProvider.formulaCells!=null){if(cE.calcState.cellProvider.formulaCells.length>0){var b=cE.calcState.cellProvider.formulaCells.shift();cE.visitCell(cE.calcState.i,b[0],b[1])}else{cE.calcState.done=true;return null}}else{if(cE.visitCell(cE.calcState.i,cE.calcState.row,cE.calcState.col)==true){cE.calcState.done=true;return null}if(cE.calcState.col>=cE.calcState.cellProvider.getNumberOfColumns(cE.calcState.row-1)){cE.calcState.row++;cE.calcState.col=1}else{cE.calcState.col++}}}if(cE.calcState.fuel!=null){cE.calcState.fuel-=1}}return cE.calcState.calcMore}},formula:null,formulaFunc:null,visitCell:function(tableI,r,c){var cell=cE.calcState.cellProvider.getCell(tableI,r,c);if(cell==null){return true}else{var value=cell.getValue();if(value==null){this.formula=cell.getFormula();if(this.formula){if(this.formula.charAt(0)=="="){this.formulaFunc=cell.getFormulaFunc();if(this.formulaFunc==null||this.formulaFunc.formula!=this.formula){this.formulaFunc=null;try{var dependencies={};var body=cE.parseFormula(this.formula.substring(1),dependencies,tableI);this.formulaFunc=function(){with(cE.fn){return eval(body)}};this.formulaFunc.formula=this.formula;this.formulaFunc.dependencies=dependencies;cell.setFormulaFunc(this.formulaFunc)}catch(e){cell.setValue(cE.ERROR+": "+e)}}if(this.formulaFunc){cE.calcState.stack.push(cE.makeFormulaEval(cell,r,c,this.formulaFunc));var dependencies=this.formulaFunc.dependencies;for(var k in dependencies){if(dependencies[k] instanceof Array&&(cE.checkCycles(dependencies[k][0],dependencies[k][1],dependencies[k][2])==true)){cell.setValue(cE.ERROR+": cycle detected");cE.calcState.stack.pop();return false}}for(var k in dependencies){if(dependencies[k] instanceof Array){cE.calcState.stack.push(cE.makeCellVisit(dependencies[k][2],dependencies[k][0],dependencies[k][1]))}}}}else{cell.setValue(cE.parseFormulaStatic(this.formula))}}}return false}},makeCellVisit:function(a,d,b){var c=function(){return cE.visitCell(a,d,b)};c.row=d;c.col=b;return c},thisCell:null,makeFormulaEval:function(a,e,b,d){cE.thisCell=a;var c=function(){try{var f=d();switch(typeof(f)){case"string":f=f.replace(cE.regEx.amp,cE.str.amp).replace(cE.regEx.lt,cE.str.lt).replace(cE.regEx.gt,cE.str.gt).replace(cE.regEx.nbsp,cE.str.nbsp)}a.setValue(f)}catch(g){}};c.row=e;c.col=b;return c},checkCycles:function(e,b,a){for(var c=0;c<cE.calcState.stack.length;c++){var d=cE.calcState.stack[c];if(d.row!=null&&d.col!=null&&d.row==e&&d.col==b&&a==cE.calcState.i){return true}}return false},foldPrepare:function(a,b){if(a!=null&&a instanceof Object&&a.length!=null){return a}else{return b}},fold:function(b,e,a,d){for(var c=0;c<b.length;c++){a=e(a,(d==true?cE.fn.N(b[c]):b[c]))}return a}};